<div class="container-fluid">
  <!-- Navigation Header -->
  <nav class="navbar navbar-expand-lg mb-4">
    <div class="container">
      <a class="navbar-brand" href="#" (click)="goToDashboard()">SpeedType</a>
      <div class="navbar-nav ms-auto">
        <span class="navbar-text me-3" *ngIf="currentUser">{{ currentUser.username }}</span>
        <button class="btn btn-outline-secondary btn-sm me-2" (click)="goToDashboard()">Dashboard</button>
        <button class="btn btn-outline-secondary btn-sm" (click)="logout()">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Test Selection Screen -->
  <div class="container" *ngIf="showSelection">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header text-center">
            <h3>Choose Your Typing Test</h3>
            <p class="mb-0 text-muted">Select from existing texts or upload your own file</p>
          </div>
          <div class="card-body">
            <!-- Upload File Section -->
            <div class="row mb-5">
              <div class="col-12">
                <h5 class="text-primary mb-3"><i class="fas fa-upload me-2"></i>Upload Your Own File</h5>
                <div class="upload-section p-4 border rounded bg-light">
                  <form [formGroup]="uploadForm" (ngSubmit)="uploadFile()">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="fileInput" class="form-label">Choose Text File</label>
                          <input 
                            type="file" 
                            id="fileInput"
                            class="form-control" 
                            accept=".txt,.doc,.docx"
                            (change)="onFileSelected($event)"
                          >
                          <div class="form-text">Supported formats: .txt, .doc, .docx (max 5MB)</div>
                        </div>
                        <div class="mb-3">
                          <label for="title" class="form-label">Title</label>
                          <input 
                            type="text" 
                            id="title"
                            class="form-control" 
                            formControlName="title"
                            placeholder="Enter a title for your text"
                          >
                        </div>
                        <div class="mb-3">
                          <label for="author" class="form-label">Author (Optional)</label>
                          <input 
                            type="text" 
                            id="author"
                            class="form-control" 
                            formControlName="author"
                            placeholder="Author name"
                          >
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="description" class="form-label">Description (Optional)</label>
                          <textarea 
                            id="description"
                            class="form-control" 
                            rows="3"
                            formControlName="description"
                            placeholder="Brief description of the text"
                          ></textarea>
                        </div>
                        <div class="mb-3">
                          <div class="form-check">
                            <input 
                              type="checkbox" 
                              id="isPublic"
                              class="form-check-input" 
                              formControlName="isPublic"
                            >
                            <label class="form-check-label" for="isPublic">
                              Make this text available to other users
                            </label>
                          </div>
                        </div>
                        <button 
                          type="submit" 
                          class="btn btn-primary btn-lg"
                          [disabled]="!selectedFile || isUploading"
                        >
                          <span *ngIf="isUploading" class="spinner-border spinner-border-sm me-2"></span>
                          {{ isUploading ? 'Uploading...' : 'Upload & Start Test' }}
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- Quick Start Options -->
            <div class="row mb-4">
              <div class="col-12">
                <h5 class="text-success mb-3"><i class="fas fa-bolt me-2"></i>Quick Start</h5>
                <div class="d-flex gap-3">
                  <button class="btn btn-success btn-lg" (click)="startRandomTest()">
                    <i class="fas fa-random me-2"></i>Random Text
                  </button>
                </div>
              </div>
            </div>

            <!-- Available Public Texts -->
            <div class="row mb-4" *ngIf="availableBooks.length > 0">
              <div class="col-12">
                <h5 class="text-info mb-3"><i class="fas fa-book me-2"></i>Public Texts</h5>
                <div class="row books-grid">
                  <div class="col-md-4" *ngFor="let book of availableBooks">
                    <div class="card book-card" (click)="selectBook(book)">
                      <div class="card-body">
                        <h6 class="card-title">{{ book.title }}</h6>
                        <p class="card-text text-muted" *ngIf="book.author">by {{ book.author }}</p>
                        <p class="card-text" *ngIf="book.description">{{ book.description }}</p>
                        
                        <div class="mt-auto">
                          <div class="d-flex justify-content-between align-items-center mb-3">
                            <small class="text-muted">
                              <i class="fas fa-book me-1"></i>{{ book.content.split(' ').length }} words
                            </small>
                            <div class="d-flex gap-2">
                              <span class="badge bg-primary">{{ book.personalBest || 0 }} WPM</span>
                              <span class="badge bg-success">Public</span>
                            </div>
                          </div>
                          
                          <div class="d-flex gap-2">
                            <button class="btn btn-primary flex-fill" (click)="selectBook(book); $event.stopPropagation()">
                              <i class="fas fa-play me-2"></i>Start Test
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- User's Personal Texts -->
            <div class="row" *ngIf="userBooks.length > 0">
              <div class="col-12">
                <h5 class="text-warning mb-3"><i class="fas fa-user me-2"></i>Your Texts</h5>
                <div class="row books-grid">
                  <div class="col-md-4" *ngFor="let book of userBooks">
                    <div class="card book-card" (click)="selectBook(book)">
                      <div class="card-body">
                        <h6 class="card-title">{{ book.title }}</h6>
                        <p class="card-text text-muted" *ngIf="book.author">by {{ book.author }}</p>
                        <p class="card-text" *ngIf="book.description">{{ book.description }}</p>
                        
                        <div class="mt-auto">
                          <div class="d-flex justify-content-between align-items-center mb-3">
                            <small class="text-muted">
                              <i class="fas fa-book me-1"></i>{{ book.content.split(' ').length }} words
                            </small>
                            <div class="d-flex gap-2">
                              <span class="badge bg-primary">{{ book.personalBest || 0 }} WPM</span>
                              <span class="badge" [class.bg-success]="book.isPublic" [class.bg-secondary]="!book.isPublic">
                                {{ book.isPublic ? 'Public' : 'Private' }}
                              </span>
                            </div>
                          </div>
                          
                          <div class="d-flex gap-2">
                            <button class="btn btn-primary flex-fill" (click)="selectBook(book); $event.stopPropagation()">
                              <i class="fas fa-play me-2"></i>Start Test
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Error Message -->
            <div class="alert alert-danger" *ngIf="errorMessage">
              {{ errorMessage }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Test Configuration Panel -->
  <div class="container test-config-panel" *ngIf="!showSelection && !isLoading && testConfiguration.showConfig">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Test Configuration</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="wordCount" class="form-label">Number of Words</label>
                  <input 
                    type="number" 
                    id="wordCount"
                    class="form-control" 
                    [(ngModel)]="wordCount"
                    min="1" 
                    max="500"
                    placeholder="Enter word count"
                  >
                  <div class="form-text">Choose how many words to practice (1-500)</div>
                </div>
              </div>
              <div class="col-md-6">
                                  <div class="mb-3">
                    <label class="form-label">Start Position</label>
                    
                    <!-- Navigation buttons -->
                    <div class="d-flex gap-2 mb-2">
                      <button 
                        type="button" 
                        class="btn btn-outline-secondary btn-sm" 
                        (click)="resetPreview()"
                        title="Go to beginning"
                      >
                        <i class="fas fa-fast-backward"></i> Start
                      </button>
                      <button 
                        type="button" 
                        class="btn btn-outline-secondary btn-sm" 
                        (click)="scrollPreviewBackward()"
                        [disabled]="previewOffset === 0"
                        title="Show previous words"
                      >
                        <i class="fas fa-chevron-left"></i> Previous
                      </button>
                      <button 
                        type="button" 
                        class="btn btn-outline-secondary btn-sm" 
                        (click)="scrollPreviewForward()"
                        [disabled]="previewOffset >= testConfiguration.totalWords - 150"
                        title="Show next words"
                      >
                        Next <i class="fas fa-chevron-right"></i>
                      </button>
                    </div>
                    
                    <div class="form-control text-selection-mode" style="height: auto; min-height: 120px; cursor: pointer;">
                      <div class="mb-2 text-muted small">
                        Showing words {{ previewOffset + 1 }} - {{ previewOffset + getPreviewWords().length }} 
                        (Click on any word to set as starting point)
                      </div>
                      <div class="text-preview">
                        <span 
                          *ngFor="let word of getPreviewWords(); let i = index"
                          class="selectable-word"
                          [class.selected-start]="previewOffset + i === startWordIndex"
                          [class.selected-range]="previewOffset + i >= startWordIndex && previewOffset + i < startWordIndex + wordCount"
                          (click)="setStartPosition(i)"
                          [title]="'Word ' + (previewOffset + i + 1)"
                        >{{ word }}</span>
                      </div>
                    </div>
                    <div class="form-text">
                      Starting at word {{ startWordIndex + 1 }} of {{ testConfiguration.totalWords }} 
                      ({{ wordCount }} words selected)
                    </div>
                  </div>
              </div>
            </div>
            
            <!-- Resume Option -->
            <div class="alert alert-info d-flex align-items-center" *ngIf="canResumeFromLast">
              <i class="fas fa-info-circle me-2"></i>
              <span class="me-auto">You can resume from word {{ lastCompletedPosition }} where you left off last time.</span>
              <button class="btn btn-outline-primary btn-sm" (click)="resumeFromLastPosition()">
                Resume from Last Position
              </button>
            </div>
            
            <div class="d-flex gap-2">
              <button class="btn btn-primary" (click)="applyTestConfiguration()">
                <i class="fas fa-play me-2"></i>Start Test
              </button>
              <button class="btn btn-secondary" (click)="cancelConfiguration()">
                Cancel
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Typing Test Interface -->
  <div class="container" *ngIf="!showSelection && !isLoading && !testConfiguration.showConfig">
    <!-- Test Controls and Stats -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center test-controls">
              <button class="btn btn-outline-secondary me-3" (click)="goToSelection()">
                <i class="fas fa-arrow-left me-2"></i>Back to Selection
              </button>
              <button class="btn btn-outline-primary me-3" (click)="showTestConfiguration()" *ngIf="!isTestActive">
                <i class="fas fa-cog me-2"></i>Configure Test
              </button>
              <button class="btn btn-outline-danger me-3" (click)="stopTest()" *ngIf="isTestActive" title="Stop test and save progress (Ctrl+S)">
                <i class="fas fa-stop me-2"></i>Stop Test
                <small class="d-none d-md-inline text-muted ms-1">(Ctrl+S)</small>
              </button>
              <h5 class="mb-0" *ngIf="book">{{ book.title }}</h5>
            </div>
            <div class="d-flex gap-3 progress-stats">
              <div class="stat-item">
                <span class="stat-label">WPM:</span>
                <span class="stat-value">{{ wpm }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Accuracy:</span>
                <span class="stat-value">{{ accuracy | number:'1.1-1' }}%</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Time:</span>
                <span class="stat-value">{{ timeElapsed }}s</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Errors:</span>
                <span class="stat-value text-danger">{{ errors }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Progress:</span>
                <span class="stat-value">{{ currentWordIndex + 1 }}/{{ words.length }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Position:</span>
                <span class="stat-value">{{ startWordIndex + currentWordIndex + 1 }}/{{ testConfiguration.totalWords }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Typing Area -->
    <div class="row" *ngIf="!isTestCompleted">
      <div class="col-12">
        <div class="card typing-area">
          <div class="card-body">
            <div class="text-display" *ngIf="testText">
              <span 
                *ngFor="let char of testText.split(''); let i = index"
                [class]="getCharacterClass(i)"
                class="char"
              >{{ char }}</span>
            </div>
            
            <div class="mt-4 text-center" *ngIf="!isTestActive">
              <p class="lead">Click here or start typing to begin the test</p>
              <button class="btn btn-primary btn-lg" (click)="startTest()">Start Test</button>
            </div>
            
            <div class="mt-4 text-center" *ngIf="isTestActive">
              <p class="text-muted">
                Type the text above. 
                <span class="d-block d-sm-inline">
                  <span class="me-2">Press <kbd>Ctrl+S</kbd> to stop and save progress.</span>
                  <span>Press <kbd>ESC</kbd> to restart.</span>
                </span>
              </p>
              <button class="btn btn-secondary" (click)="restartTest()">Restart Test</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Test Results -->
    <div class="row" *ngIf="isTestCompleted">
      <div class="col-12">
        <div class="card">
          <div class="card-header text-center">
            <h3 [class]="isTestCompleted ? (currentWordIndex >= words.length ? 'text-success' : 'text-warning') : 'text-success'">
              <i [class]="currentWordIndex >= words.length ? 'fas fa-check-circle' : 'fas fa-pause-circle'" class="me-2"></i>
              {{ currentWordIndex >= words.length ? 'Test Completed!' : 'Test Stopped' }}
            </h3>
            <p class="mb-0 text-muted" *ngIf="currentWordIndex < words.length">
              Progress: {{ currentWordIndex + 1 }}/{{ words.length }} words ({{ ((currentWordIndex + 1) / words.length * 100) | number:'1.0-0' }}%)
            </p>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-md-3">
                <div class="result-stat">
                  <h2 class="text-primary">{{ wpm }}</h2>
                  <p class="mb-0">Words per Minute</p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="result-stat">
                  <h2 class="text-success">{{ accuracy | number:'1.1-1' }}%</h2>
                  <p class="mb-0">Accuracy</p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="result-stat">
                  <h2 class="text-info">{{ timeElapsed }}s</h2>
                  <p class="mb-0">Time Taken</p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="result-stat">
                  <h2 class="text-danger">{{ errors }}</h2>
                  <p class="mb-0">Errors</p>
                </div>
              </div>
            </div>
            
            <!-- Additional info for stopped tests -->
            <div class="mt-4" *ngIf="wasTestStopped">
              <div class="alert alert-info">
                <h6 class="alert-heading">
                  <i class="fas fa-info-circle me-2"></i>Test Stopped Early
                </h6>
                <p class="mb-2">Your progress has been saved! You can continue from where you left off next time.</p>
                <small class="text-muted">
                  • Words completed: {{ currentWordIndex + 1 }} out of {{ words.length }}
                  • Characters typed: {{ charactersTyped }}
                  • Saved position: Word {{ startWordIndex + currentWordIndex + 1 }} in the full text
                </small>
              </div>
            </div>
            
            <div class="text-center mt-4">
              <button class="btn btn-primary me-3" (click)="restartTest()">
                {{ wasTestStopped ? 'Continue Test' : 'Try Again' }}
              </button>
              <button class="btn btn-secondary me-3" (click)="goToSelection()">Choose Different Text</button>
              <button class="btn btn-outline-primary" (click)="goToDashboard()">Dashboard</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div class="container text-center" *ngIf="isLoading">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3">Loading...</p>
  </div>
</div> 